pipeline {
  options {
    timeout( time:30, unit:'MINUTES') 
  }
  environment {
   NAME = "ABHIJIT" 
    APPNAME = "movies"
    STAGE = "stage"
    NEXUS_SERVER = "http://nexus-common.apps.na45.prod.nextcle.com/repository/java"
  }
  agent {
    node {
      label 'maven' 
    }
  }
  
  stages {
    stage("BUILD") {
      steps {
        sh '''
          cd pipeline
          echo "Compiling on $NEXUS_SERVER"
          grep url settings.xml
          # mvn -s settings.xml clean compile
          echo "Packaging"
          mvn -s settings.xml clean package
          pwd
          ls -lrt target
          echo "Building" 
          
          oc delete all -l app=${APPNAME} -n $STAGE
          oc delete all -l build=${APPNAME} -n $STAGE
          
          oc new-build --name=${APPNAME} java:8 --binary=true -n $STAGE
        '''
        
        script {
            openshift.withCluster() {
                openshift.withProject("$STAGE") {
                  openshift.selector("bc", "$APPNAME").startBuild("--from-file=pipeline/target/movies.jar", "--wait=true", "--follow=true")
            }
          }
          echo "started building"
          

        }
        sh '''
        echo "Creating app from is"
        oc new-app ${APPNAME}:latest --as-deployment-config -n $STAGE
        oc expose svc $APPNAME  -n $STAGE
        '''
        script {
         openshift.withCluster() {
                openshift.withProject("$STAGE") {
                  openshift.selector("dc","$APPNAME").related('pods').untilEach(1) {
                    return (it.object().status.phase == 'Running')
                  }
                }
          } 
        }
        
        sh '''
        curl http://movies-stage.apps.na45.prod.nextcle.com/movies
        '''
      }
    }
    stage("PRODUCTION") {
      steps {
       sh '''
     echo "Deploying in production"
     oc project prd
     oc delete all -l app=$APPNAME
     ''' 
        script {
          openshift.withCluster() {
           openshift.tag("stage/movies:latest", "prd/movies:latest" )
          }
          sh '''
            oc new-app --as-deployment-config --name movies prd/movies:latest -n prd
            oc expose svc movies
            curl http://movies-prd.apps.na45.prod.nextcle.com/movies
          '''
          script {
            openshift.withCluster() {
              openshift.withProject("prd") {
                openshift.selector("dc", "movies").related('pods').untilEach(1) {
                 return (it.object().status.phase == 'Running' ) 
                }
              }
            }
          }
          sh '''
          sleep 5
            curl http://movies-prd.apps.na45.prod.nextcle.com/movies
          '''
          
        }
      }
    }
  }
}
